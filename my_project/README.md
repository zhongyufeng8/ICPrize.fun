使用容器地址接收代币，控制权之后需丢到黑洞

ICPrize 是一款构建于 ICP 区块链之上的去中心化游戏合约系统，玩家通过下注参与奖池，最后一笔下注后若 60 秒内无人再下注，即触发结算，由创建者设置最后参与者地址均分奖池。

该项目支持多币种（ICP/ICRC-1）下注，允许用户自主创建游戏池，设置分奖人数，添加初始资金，吸引其他玩家参与，实现一个无中间人、完全透明、公平分发的娱乐竞技平台。

---

## 🧩 流程图（主流程）

```
[添加代币]
    ↓
[创建池子]
    ↓
[倒计时启动]
    ↓
┌──────────── 投注（倒计时重置） ────────────┐
↓                                              ↑
[多人参与中]  ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←┘
    ↓
倒计时结束
    ↓
[结算 & 分发奖励]
    ↓
[状态完成/可删除]
```

---

## 🧩 流程图（无人下注情况）

```
┌────────── 无人下注 ───────────┐
↓                                ↓
[倒计时结束]                → [返还初始资金 → 标记取消]
                                 ↓
                           [删除池子/清理]
```

## 🔄 示例流程

用户 A 创建池子（设置 10 人均分 + 初始资金 10 ICP）
↓
用户 B 下注 0.01 ICP（奖池 +0.01，倒计时重置 60s）
↓
用户 C 下注 0.01 ICP（奖池 +0.01，倒计时重置 60s）
↓
...
↓
60 秒无人下注
↓
触发结算 → 最后（如设置的10名地址）参与者平分奖池（总额 * 98% / 人数）
↓
用户 A 获得 1%，平台获得 1%
↓
状态标记为已完成并清理资源

---

## ⚙️ 常量配置

- 每次投注后的倒计时：60 秒  
- 创建者手续费：1%  
- 平台/开发者手续费：1%  
- 代币标准：ICRC-1  
- 网络费用：储存中查询  
- 开发者地址：待填  
- 最小下注：根据代币小数位计算（减去4位）

---

## 🔧 变量说明

- **最小下注**：用于计算最小下注金额（减去4位）比如：小数6位1000000，最小下注是100 
- **固定储存**：代币地址、小数位、代币符号、logo元数据  
- **临时存储**：池子数据（创建者地址、分享奖金地址）
- **初始资金**：用于计算最小初始资金 人数*最小下注=最低初始资金
---

## 🧩 功能模块说明

### 1. 添加代币

- **参数**：账本地址  
- **返回**：账本地址、logo元数据、小数位、代币符号、网络费用 
- **操作**：存储代币信息到本地  
查询已经添加的代币：只显示符号
### 2. 创建池子

- **参数**：
  - 人数（如设置10人，最后10个地址分配98%奖金）
  - 下注金额（需高于 网络费用）
  - 币种（从已添加中选择）
  - 初始投入
  返回：人数、下注金额、币种、初始投入 
- **查询**：
  
  - 查询流动性：输入池子 ID → 返回这个池子总资金  
  - 查询池子：活跃的排名


### 3. 投注

- **参数**：池子ID、下注金额  
- **返回**：时间、下注金额  
- **查询记录**：金额、时间、中奖范围（最后地址设置的地址）
查询排名是否再中奖范围，输入地址，返回排名。
### 4. 倒计时控制

- **启动倒计时**：创建池子后启动  
- **重置倒计时**：每次投注后自动重置  
- **结束倒计时**：倒计时结束即结算池子并不允许投注 
- **查询**：倒计时时间  

### 5. 结算与奖励发放

- **规则**：
  - 校验：检查金额+地址+时间+最后名次才能获奖
  - 同一地址多次下注也计算在内，计算最后的地址数
  - 预留网络费用，计算费用并分发
  - 奖金池：98% 均分，1% 创建者，1% 开发者
- **查询**：结算状态（完成/进行中）  

### 6. 删除池子

- **操作**：创建池子时检查旧池子是否已结束，顺便清理  

### 7. 无人下注处理

- **规则**：倒计时结束无人下注 →  
  - 返还初始资金  
  - 标记为取消  
  - 删除池子或清理缓存  

### 8. 聊天室功能

- **参数**：文本
- **查询**：
  - 是否有新消息
  - 获取最新消息（不记录历史消息）

### 9. ICRC1转账功能

- **参数**：代币地址、转账金额
- **返回**：成功/失败状态

---



### 模块组织

```
src/
├── my_project_backend/
│   ├── main.mo                 // 主入口文件
│   ├── types.mo                // 数据类型定义
│   ├── token.mo                // 代币相关操作
│   ├── pool.mo                 // 游戏池相关操作
│   ├── bet.mo                  // 下注相关操作
│   ├── settlement.mo           // 结算相关操作
│   ├── timer.mo                // 倒计时管理
│   ├── message.mo              // 聊天消息处理
│   └── utils.mo                // 工具函数
├── my_project_frontend/        // 前端代码
├── declarations/               // 类型声明
└── assets/                     // 静态资源
```

### 系统架构

- **转账验证**：所有操作以转账地址为准，通过转账行为确认用户身份和操作意图
- **存储模式**：使用稳定变量（stable variables）保证数据持久性
- **异步处理**：通过async/await处理异步操作如代币转账
- **时间戳机制**：使用区块时间戳记录下注时间，避免使用高消耗的定时器调用
- **安全性**：通过转账验证来确保操作有效性，包括添加代币、创建池子、投注等均通过支付相应代币确认
- **错误处理**：采用Result类型进行错误处理和传播
